trigger:
  branches:
    include:
      - master

stages:
- stage: Build
  displayName: "Build Node.js App"
  jobs:
  - job: BuildJob
    displayName: "Install & Package Express App"
    pool:
      vmImage: "ubuntu-latest"
    steps:
    - task: NodeTool@0
      inputs:
        versionSpec: "18.x"
      displayName: "Install Node.js"

    - script: |
        echo "Installing npm packages for build..."
        npm install
      displayName: "Install npm packages (build)"

    - script: |
        echo "Listing workspace files for debugging..."
        ls -lh
      displayName: "Debug: List files"

    - task: ArchiveFiles@2
      inputs:
        rootFolderOrFile: "$(Build.SourcesDirectory)"
        includeRootFolder: false
        archiveType: "zip"
        archiveFile: "$(Build.ArtifactStagingDirectory)/express-app.zip"
      displayName: "Archive Node.js application"

    - task: PublishPipelineArtifact@1
      inputs:
        targetPath: "$(Build.ArtifactStagingDirectory)"
        artifactName: "nodeapp"
      displayName: "Publish artifact for deployment"

- stage: Deploy
  displayName: "Deploy to Remote Server"
  dependsOn:
  - Build
  jobs:
  - job: DeployJob
    displayName: "Deploy Express App"
    pool:
      name: "Java_Deployment"
    steps:
    - task: DownloadPipelineArtifact@2
      inputs:
        artifact: "nodeapp"
        path: "$(Pipeline.Workspace)/nodeapp"
      displayName: "Download build artifact"

    - task: CopyFilesOverSSH@0
      inputs:
        sshEndpoint: "Java_YAML"
        sourceFolder: "$(Pipeline.Workspace)/nodeapp"
        contents: "express-app.zip"
        targetFolder: "/home/itadmin/nodeapp"
      displayName: "Copy artifact to remote server"

    - task: SSH@0
      inputs:
        sshEndpoint: "Java_YAML"
        runOptions: "inline"
        inline: |
          echo "Preparing deployment folder..."
          mkdir -p /home/itadmin/nodeapp
          unzip -o /home/itadmin/nodeapp/express-app.zip -d /home/itadmin/nodeapp

          cd /home/itadmin/nodeapp

          echo "Cleaning old node_modules..."
          rm -rf node_modules

          echo "Installing production dependencies..."
          npm install --omit=dev

          echo "Ensuring PM2 log rotation is enabled..."
          pm2 install pm2-logrotate || echo "pm2-logrotate already installed"
          pm2 set pm2-logrotate:max_size 10M
          pm2 set pm2-logrotate:retain 10

          echo "Restarting PM2 process..."
          pm2 restart expressapp || pm2 start app.js --name expressapp

          echo "Performing basic health check..."
          if curl -fs http://localhost:3000/health > /dev/null; then
            echo "Health check passed!"
          else
            echo "Health check failed!"
          fi

          echo "Deployment Complete!"
      displayName: "Deploy & restart Node.js app"
